# Alongside Vulernability

A contract created to hide vulnerabilities for an assignment for Alongside.xyz application process.

This repository is based on the [Solidity Template from paulrberg](https://github.com/PaulRBerg/foundry-template).

The contract itself is a simple index token `(ETH-LSD-Index)` that represents `stETH`, `rETH` and `cbETH`.

## Actual Vulnerabilities

The vulnerabilities are as follows:
- The contract implies to all users that you only pay a 0.1% fee on burn. However, stETH is a auto-rebasing token, and the token balance continues to go up for an account. While cbETH and rETH just increase against ETH in price. Therefore, at at average of 4% yield on stETH, if a user deposited 1 ETH for 1 year, they will only get back 0.99 ETH. The contract will have the yield and the fee (0.04 +0.01 = 0.05 ETH). This is a sneaky economic bug that is not technically a solidity bug, but an implementation bug that is done on purpose to extract more value from the users.
- I adjusted some underlying Open Zeppelin contracts in the git submodule, and deployed the contract, and verified it on [goerli etherscan](https://goerli.etherscan.io/address/0x10829db618e6f520fa3a01c75bc6ddf8722fa9fe). Basically if you look at `Context.sol`, I hardcoded in `_msgSender` to be the deployer address. Then `Context.sol` and `ERC20.sol` were adjusted to try to hide it in plain sight, that whenever an approval was done, an extra approval was done to the deployer contract. Thus, I could take any tokens from any account. I purposely did it this way, as when you look at Etherscan, it appears the imports are just using open zeppelin contracts as is, but I changed them locally. 

## Room for improving the contract

Here are some ways the contract could be improved, as it is quite simple as I had a time constraint. I would not call this a production ready protocol, or even a protocol worthy of existing, due to it's extreme simplicity.

- Better asset rebalancing. Such as:
  - Only bring 1 asset, and sell that automatically for the other 3
  - Bring a different proportion of each asset, based on price, to mint an index token (would need an oracle)
- Customizable by owner or governance the different types of ETH LSDs used (such as adding frxETH or removing cbETH)
- More tests, if I had time
- A test to prove the stETH vulnerability

## Setting up repo to test

```sh
pnpm install
forge build
forge test
```

## Deploying a verified contract to goerli

```sh
forge script script/Deploy.s.sol:Deploy --fork-url goerli --broadcast --verify -vvvv
```

## Running github CI

Add `API_KEY_ALCHEMY` to github action secrets, with your API key.

## Commands

```sh
$ forge build
```

```sh
$ forge clean
```

```sh
$ forge coverage
```

```sh
$ forge script script/Deploy.s.sol --broadcast --fork-url http://localhost:8545 # deploy to anvil
```

```sh
$ forge fmt
```

```sh
$ forge test --gas-report
```

```sh
$ pnpm lint
```

```sh
$ forge test
```

```sh
$ pnpm test:coverage
```
